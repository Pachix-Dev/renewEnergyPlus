---
import { ProgramaModalWrapper } from './ProgramaModalWrapper'
import i18next from 'i18next'

interface Props {
  escenario: any
}

const { escenario } = Astro.props

const API_URL = import.meta.env.DEV
  ? 'http://localhost:3000/ponentes/'
  : 'https://dashboard.igeco.mx/ponentes/'

const currentLanguage = i18next.language || 'es'

const typeColors = {
  keynote: 'from-[#5E5884] to-[#7B6FA8]',
  panel: 'from-[#1E293B] to-[#5E5884]',
  workshop: 'from-[#0ea5e9] to-[#7B6FA8]',
  networking: 'from-[#5E5884] to-[#14b8a6]',
  default: 'from-[#334155] to-[#475569]',
}

const getTypeColor = (type: string) => {
  return typeColors[type as keyof typeof typeColors] || typeColors.default
}

const typeLabels = {
  keynote: 'Keynote',
  panel: 'Panel',
  workshop: 'Workshop',
  networking: 'Networking',
  default: 'Sesión',
}

const getTypeLabel = (type: string) => {
  return typeLabels[type as keyof typeof typeLabels] || typeLabels.default
}

const getTags = (tags: any) => {
  if (!tags) return []
  if (Array.isArray(tags)) return tags
  if (typeof tags === 'string') {
    try {
      const parsed = JSON.parse(tags)
      return Array.isArray(parsed) ? parsed : [tags]
    } catch {
      return tags.split(',').map((t: string) => t.trim())
    }
  }
  return []
}

const getPonentes = (ponentes: any) => {
  if (!ponentes) return []
  if (Array.isArray(ponentes)) return ponentes
  return []
}
---

<section
  class='relative overflow-hidden bg-gradient-to-b from-[#0B1224] via-[#0f172a] to-[#1E293B] text-white py-16 sm:py-20 px-4 sm:px-6'
>
  <div class='absolute inset-0 pointer-events-none'>
    <div
      class='absolute -top-24 -left-16 w-72 h-72 bg-[#5E5884]/30 blur-3xl rounded-full'
    >
    </div>
    <div
      class='absolute bottom-0 right-0 w-96 h-96 bg-[#0ea5e9]/20 blur-3xl rounded-full'
    >
    </div>
    <div
      class='absolute top-1/3 right-1/4 w-48 h-48 bg-[#7B6FA8]/20 blur-2xl rounded-full'
    >
    </div>
  </div>

  <div class='relative max-w-7xl mx-auto space-y-12'>
    <div
      class='bg-white/5 border border-white/10 rounded-3xl p-8 md:p-12 shadow-[0_30px_120px_rgba(0,0,0,0.35)] backdrop-blur-xl'
    >
      <div
        class='flex flex-col md:flex-row md:items-center md:justify-between gap-6'
      >
        <div class='flex-1 space-y-4'>
          <div
            class='inline-flex items-center gap-2 px-4 py-2 rounded-full bg-white/10 border border-white/10 text-xs font-semibold uppercase tracking-[0.25em]'
          >
            <svg
              xmlns='http://www.w3.org/2000/svg'
              fill='none'
              viewBox='0 0 24 24'
              stroke-width='1.5'
              stroke='currentColor'
              class='size-6'
            >
              <path
                stroke-linecap='round'
                stroke-linejoin='round'
                d='M12 18.75a6 6 0 0 0 6-6v-1.5m-6 7.5a6 6 0 0 1-6-6v-1.5m6 7.5v3.75m-3.75 0h7.5M12 15.75a3 3 0 0 1-3-3V4.5a3 3 0 1 1 6 0v8.25a3 3 0 0 1-3 3Z'
              ></path>
            </svg>

            <span>Escenario</span>
          </div>
          <h2
            class='text-3xl md:text-5xl font-black leading-tight drop-shadow-lg'
          >
            {escenario.name}
          </h2>
          {
            escenario.description && (
              <p class='text-lg text-white/80 leading-relaxed'>
                {escenario.description}
              </p>
            )
          }
        </div>

        {
          (escenario.location || escenario.capacity) && (
            <div class='flex flex-col gap-3 md:items-end text-sm text-white/80'>
              {escenario.location && (
                <div class='flex items-center gap-3 bg-white/10 border border-white/10 backdrop-blur-sm px-5 py-3 rounded-xl shadow-md'>
                  <svg
                    class='w-5 h-5'
                    fill='none'
                    viewBox='0 0 24 24'
                    stroke='currentColor'
                  >
                    <path
                      stroke-linecap='round'
                      stroke-linejoin='round'
                      stroke-width='2'
                      d='M12 11c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3z'
                    />
                    <path
                      stroke-linecap='round'
                      stroke-linejoin='round'
                      stroke-width='2'
                      d='M12 22s8-4.5 8-12a8 8 0 10-16 0c0 7.5 8 12 8 12z'
                    />
                  </svg>
                  <span class='font-semibold'>{escenario.location}</span>
                </div>
              )}
            </div>
          )
        }
      </div>
    </div>

    <div class='space-y-12'>
      {
        escenario.dias && escenario.dias.length > 0 ? (
          escenario.dias.map((dia: any, diaIndex: number) => (
            <div
              class='dia-container relative'
              data-aos='fade-up'
              data-aos-delay={diaIndex * 100}
            >
              <div class='sticky top-4 z-10'>
                <div class='flex items-center gap-4 bg-white/5 border border-white/10 backdrop-blur-xl rounded-2xl px-6 py-4 shadow-lg'>
                  <div class='w-14 h-14 sm:w-16 sm:h-16 bg-gradient-to-br from-[#5E5884] to-[#7B6FA8] rounded-2xl flex items-center justify-center text-2xl font-black text-white shadow-lg'>
                    {new Date(dia.date).getDate()}
                  </div>
                  <div>
                    <h3 class='text-xl sm:text-2xl font-bold capitalize'>
                      {new Date(dia.date).toLocaleDateString('es-ES', {
                        weekday: 'long',
                      })}
                    </h3>
                    <p class='text-sm text-white/70'>
                      {new Date(dia.date).toLocaleDateString('es-ES', {
                        day: 'numeric',
                        month: 'long',
                        year: 'numeric',
                      })}
                    </p>
                  </div>
                  <div class='ml-auto hidden md:flex items-center gap-2 bg-white/10 border border-white/10 px-4 py-2 rounded-full text-xs font-semibold text-white/80'>
                    <svg
                      class='w-4 h-4'
                      fill='none'
                      viewBox='0 0 24 24'
                      stroke='currentColor'
                    >
                      <path
                        stroke-linecap='round'
                        stroke-linejoin='round'
                        stroke-width='2'
                        d='M12 8v4l3 3'
                      />
                      <circle
                        cx='12'
                        cy='12'
                        r='9'
                        stroke='currentColor'
                        stroke-width='2'
                      />
                    </svg>
                    <span>
                      {dia.conferencias?.length || 0}{' '}
                      {dia.conferencias?.length === 1 ? 'sesión' : 'sesiones'}
                    </span>
                  </div>
                </div>
              </div>

              {dia.conferencias && dia.conferencias.length > 0 ? (
                <div class='relative pt-6 md:pt-10'>
                  <div class='absolute left-6 md:left-24 top-0 bottom-0 w-px bg-gradient-to-b from-[#7B6FA8] via-[#5E5884] to-transparent opacity-60' />

                  <div class='space-y-10'>
                    {dia.conferencias
                      .sort((a: any, b: any) =>
                        a.start_time.localeCompare(b.start_time)
                      )
                      .map((conf: any, confIndex: number) => {
                        const ponentes = getPonentes(conf.ponentes)
                        const tags = getTags(conf.tags)

                        return (
                          <article
                            class='relative pl-14 md:pl-32 group'
                            data-aos='fade-left'
                            data-aos-delay={confIndex * 60}
                          >
                            <div class='absolute left-0 top-0 flex flex-col items-center md:items-start gap-3'>
                              <div class='absolute left-6 md:left-24 w-4 h-4 bg-white border-4 border-[#7B6FA8] rounded-full shadow-lg transform -translate-x-1/2 group-hover:scale-125 transition-transform duration-300' />

                              <time class='flex flex-col items-center md:items-start bg-white/10 border border-white/10 text-white px-3 py-4 md:py-2 rounded-xl shadow-lg font-semibold text-xs sm:text-sm  md:min-w-[110px]'>
                                <span class='text-[10px] uppercase tracking-wide text-white/60'>
                                  Inicio
                                </span>
                                <span>{conf.start_time.slice(0, 5)}</span>
                              </time>
                              <time class='flex flex-col items-center md:items-start bg-white/5 border border-white/10 text-white px-3 py-2 rounded-xl shadow-lg font-semibold text-xs sm:text-sm  md:min-w-[110px]'>
                                <span class='text-[10px] uppercase tracking-wide text-white/60'>
                                  Fin
                                </span>
                                <span>{conf.end_time.slice(0, 5)}</span>
                              </time>
                            </div>

                            <div class='bg-white/5 border border-white/10 rounded-2xl shadow-xl overflow-hidden backdrop-blur-xl transition-all duration-300 transform group-hover:-translate-y-1 group-hover:shadow-2xl'>
                              <div
                                class={`bg-gradient-to-r ${getTypeColor(conf.type)} px-6 py-3 border-b border-white/10`}
                              >
                                <div class='flex items-center justify-between gap-3'>
                                  <span class='inline-block text-white font-bold text-sm uppercase tracking-wide drop-shadow'>
                                    {getTypeLabel(conf.type)}
                                  </span>
                                  {conf.room && (
                                    <span class='inline-flex items-center gap-2 text-white/90 text-xs bg-white/15 border border-white/20 px-3 py-1 rounded-full'>
                                      <svg
                                        class='w-4 h-4'
                                        fill='none'
                                        viewBox='0 0 24 24'
                                        stroke='currentColor'
                                      >
                                        <path
                                          stroke-linecap='round'
                                          stroke-linejoin='round'
                                          stroke-width='2'
                                          d='M3 7h18M3 12h18M3 17h18'
                                        />
                                      </svg>
                                      <span>Sala {conf.room}</span>
                                    </span>
                                  )}
                                </div>
                              </div>

                              <div class='p-6 space-y-4'>
                                <h4 class='text-xl sm:text-2xl font-bold leading-tight text-white'>
                                  {conf.title}
                                </h4>

                                {conf.description && (
                                  <p class='text-white/80 leading-relaxed'>
                                    {conf.description}
                                  </p>
                                )}

                                {ponentes.length > 0 && (
                                  <div class='border-t border-white/10 pt-4 space-y-3'>
                                    <div class='flex items-center gap-2 text-white'>
                                      <svg
                                        class='w-5 h-5'
                                        fill='none'
                                        viewBox='0 0 24 24'
                                        stroke='currentColor'
                                      >
                                        <path
                                          stroke-linecap='round'
                                          stroke-linejoin='round'
                                          stroke-width='2'
                                          d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4z'
                                        />
                                        <path
                                          stroke-linecap='round'
                                          stroke-linejoin='round'
                                          stroke-width='2'
                                          d='M6.5 20a5.5 5.5 0 1111 0'
                                        />
                                      </svg>
                                      <h5 class='font-bold'>
                                        {ponentes.length > 1
                                          ? 'Ponentes'
                                          : 'Ponente'}
                                      </h5>
                                    </div>

                                    <div class='grid grid-cols-1 md:grid-cols-2 gap-3'>
                                      {ponentes.map((ponente: any) => (
                                        <div
                                          class='flex items-center gap-3 bg-white/5 border border-white/10 rounded-xl p-4 hover:bg-white/10 transition-colors duration-200 cursor-pointer'
                                          data-ponente={JSON.stringify(ponente)}
                                          data-action='open-modal'
                                        >
                                          {ponente.photo ? (
                                            <img
                                              src={`${API_URL}${ponente.photo}`}
                                              alt={ponente.name}
                                              class='w-14 h-14 rounded-full object-cover border-2 border-[#7B6FA8] shadow-md'
                                              loading='lazy'
                                              width='56'
                                              height='56'
                                            />
                                          ) : (
                                            <div class='w-14 h-14 rounded-full bg-gradient-to-br from-[#5E5884] to-[#7B6FA8] flex items-center justify-center text-white font-bold text-lg border-2 border-white shadow-md'>
                                              {ponente.name?.charAt(0) || '?'}
                                            </div>
                                          )}
                                          <div class='flex-1 min-w-0'>
                                            <strong class='block text-white font-semibold truncate'>
                                              {ponente.name}
                                            </strong>
                                            {ponente.position && (
                                              <span class='block text-sm text-white/70 truncate'>
                                                {ponente.position}
                                              </span>
                                            )}
                                            {ponente.company && (
                                              <span class='block text-xs text-white/60 truncate'>
                                                {ponente.company}
                                              </span>
                                            )}
                                          </div>
                                        </div>
                                      ))}
                                    </div>
                                  </div>
                                )}

                                {tags.length > 0 && (
                                  <div class='flex flex-wrap gap-2'>
                                    {tags.map((tag: string) => (
                                      <span class='px-3 py-1 bg-white/10 border border-white/10 text-white/80 text-xs font-semibold rounded-full'>
                                        #{tag}
                                      </span>
                                    ))}
                                  </div>
                                )}
                              </div>
                            </div>
                          </article>
                        )
                      })}
                  </div>
                </div>
              ) : (
                <div class='text-center py-12 bg-white/5 border border-white/10 rounded-2xl backdrop-blur-xl'>
                  <p class='text-white/70'>
                    No hay conferencias programadas para este día
                  </p>
                </div>
              )}
            </div>
          ))
        ) : (
          <div class='text-center py-20 bg-white/5 border border-white/10 rounded-2xl backdrop-blur-xl'>
            <div class='inline-block p-8 bg-white/5 border border-white/10 rounded-full mb-6'>
              <svg
                class='w-16 h-16 text-white/40'
                fill='none'
                viewBox='0 0 24 24'
                stroke='currentColor'
              >
                <path
                  stroke-linecap='round'
                  stroke-linejoin='round'
                  stroke-width='2'
                  d='M12 8v4l3 3'
                />
                <circle
                  cx='12'
                  cy='12'
                  r='9'
                  stroke='currentColor'
                  stroke-width='2'
                />
              </svg>
            </div>
            <h3 class='text-2xl font-bold text-white mb-2'>
              No hay conferencias programadas
            </h3>
            <p class='text-white/70'>
              El programa estará disponible próximamente
            </p>
          </div>
        )
      }
    </div>
  </div>
</section>

<ProgramaModalWrapper
  client:load
  apiUrl={API_URL}
  currentLanguage={currentLanguage}
/>

<style>
  .dia-container {
    scroll-margin-top: 96px;
  }
</style>
